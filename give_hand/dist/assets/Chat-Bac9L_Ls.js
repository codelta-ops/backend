import{_ as x,a as D,r as c,m as U,c as r,b as a,t as p,F as $,f as B,w as F,v as A,q as E,i as H,z as b,o as i,s as f,n as w}from"./index-CeEdpuPy.js";import{a as V,s as z}from"./messages-DSU9JwzA.js";import"./http-CWkExEYz.js";const K={class:"page"},N={class:"top"},j={class:"title"},q={key:0,class:"time-divider"},L={key:0,class:"avatar"},O=["src"],R={class:"bubble-container"},G={key:1,class:"avatar"},J=["src"],P={class:"footer"},Q={__name:"Chat",setup(W){const h=H(),o=D({}),l=c([]),v=c([]),n=c(""),u=c(null),_=c("");function y(){return{avatar:"https://api.dicebear.com/7.x/initials/svg?seed=Me",username:"我"}}function k(s){if(!s)return"";const e=new Date(s);return`${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}`}function g(s){return s.map((e,t)=>{let d=!1;if(t===0)d=!0;else{const I=new Date(e.time).getTime(),S=new Date(s[t-1].time).getTime();Math.abs(I-S)/(1e3*60)>5&&(d=!0)}return{...e,showTime:d}})}async function T(){try{const s=await V(h.params.userId);Object.assign(o,s.otherUser||{}),l.value=s.messages||[],v.value=g(l.value),_.value=y().avatar,await b(),m()}catch(s){console.error("获取聊天失败:",s)}}function m(){u.value&&(u.value.scrollTop=u.value.scrollHeight)}async function M(){if(!n.value.trim())return;const s=n.value.trim();n.value="";try{const e=await z({receiverId:o.userUid||h.params.userId,content:s}),t={msgId:e.msgId,content:e.content,time:e.time,isMine:!0};l.value.push(t),v.value=g(l.value),await b(),m()}catch(e){console.error("发送失败:",e),n.value=s}}function C(){setTimeout(()=>{m()},100)}return U(T),(s,e)=>(i(),r("div",K,[a("header",N,[a("button",{class:"back",onClick:e[0]||(e[0]=t=>s.$router.back())},"←"),a("div",j,p(o.username||"聊天"),1)]),a("main",{class:"main",ref_key:"scrollEl",ref:u},[(i(!0),r($,null,B(v.value,(t,d)=>(i(),r("div",{key:t.msgId,class:"msg-item"},[t.showTime?(i(),r("div",q,p(k(t.time)),1)):f("",!0),a("div",{class:w(["msg-row",{mine:t.isMine}])},[t.isMine?f("",!0):(i(),r("div",L,[a("img",{src:o.avatar||"https://api.dicebear.com/7.x/initials/svg?seed="+o.username,alt:"avatar"},null,8,O)])),a("div",R,[a("div",{class:w(["bubble",{mine:t.isMine}])},p(t.content),3)]),t.isMine?(i(),r("div",G,[a("img",{src:_.value||"https://api.dicebear.com/7.x/initials/svg?seed=Me",alt:"avatar"},null,8,J)])):f("",!0)],2)]))),128))],512),a("footer",P,[F(a("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>n.value=t),class:"input",placeholder:"输入消息...",onKeyup:E(M,["enter"]),onFocus:C},null,544),[[A,n.value]]),a("button",{class:"send",onClick:M},"发送")])]))}},te=x(Q,[["__scopeId","data-v-a73819ae"]]);export{te as default};
